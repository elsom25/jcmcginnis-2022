<%
  # Pages can signal they need light header text on dark backgrounds (ghost state only)
  header_light = page.data.header_theme == "light"
%>
<!-- Spacer: reserves space for compact (scrolled) header in document flow -->
<div class="h-header-compact" aria-hidden="true"></div>

<header
  id="site-header"
  class="fixed top-0 left-0 right-0 z-50 transition-all duration-300 ease-out group/header"
  data-scrolled="false"
  data-theme="<%= header_light ? 'light' : 'default' %>">
  <!-- Scroll-aware background layer
       Fast fade-out (100ms) when returning to ghost, slower fade-in (300ms) when scrolling down.
       The [data-scrolled=true] state adds its own slower transition. -->
  <div class="header-bg absolute inset-0 -z-10 transition-all duration-100 ease-out
              bg-transparent backdrop-blur-none shadow-none
              group-data-[scrolled=true]/header:duration-300
              group-data-[scrolled=true]/header:bg-white/90
              group-data-[scrolled=true]/header:dark:bg-stone-900/80
              group-data-[scrolled=true]/header:backdrop-blur-md
              group-data-[scrolled=true]/header:shadow-sm
              group-data-[scrolled=true]/header:shadow-stone-900/5
              group-data-[scrolled=true]/header:dark:shadow-black/10">
  </div>

  <!-- Wide page margins to match hero sections -->
  <div class="w-full max-w-[90rem] mx-auto px-6 md:px-12">
    <!-- Ghost: tall on desktop, compact on mobile. Scrolled: always compact. -->
    <div class="flex items-center justify-between h-header-compact md:h-header-ghost group-data-[scrolled=true]/header:h-header-compact transition-all duration-300 ease-out">
      <!-- Logo: Serif name with underline (descenders layer above it via z-index) -->
      <a href="/" class="group/logo relative flex items-center" aria-label="Home">
        <span class="relative isolate font-serif text-xl font-bold tracking-tight transition-colors
                     <%= header_light ? 'text-white dark:text-white group-data-[scrolled=true]/header:text-stone-800 group-data-[scrolled=true]/header:dark:text-stone-100' : 'text-stone-800 dark:text-stone-100' %>
                     group-hover/logo:text-brand-600 dark:group-hover/logo:text-brand-400">
          Jesse McGinnis
          <!-- Underline behind text (-z-10), descenders appear on top -->
          <span class="absolute inset-x-0 bottom-0 -z-10 h-px bg-brand-500 transition-all duration-200
                       <%= page.relative_url == '/' ? 'w-full' : 'w-0 group-hover/logo:w-full' %>"></span>
        </span>
      </a>

      <%= render "header/desktop_nav", menu: menu, page: page, header_light: header_light %>
      <%= render "header/mobile_nav", header_light: header_light %>
    </div>
  </div>

  <%= render "header/mobile_drawer", menu: menu, page: page %>

  <script>
    (function() {
      // Scroll-aware header state
      const header = document.getElementById('site-header');
      let ticking = false;

      function updateHeader() {
        // Simple threshold - fixed positioning means no layout jiggle
        header.dataset.scrolled = window.scrollY > 48;
        ticking = false;
      }

      window.addEventListener('scroll', () => {
        if (!ticking) {
          requestAnimationFrame(updateHeader);
          ticking = true;
        }
      }, { passive: true });

      updateHeader(); // Set initial state

      // Theme toggle - uses global Theme module from base layout
      const buttons = document.querySelectorAll('.theme-btn');
      const updateButtons = () => {
        const current = Theme.get();
        buttons.forEach(btn => { btn.dataset.active = btn.dataset.theme === current; });
      };
      buttons.forEach(btn => {
        btn.addEventListener('click', () => { Theme.set(btn.dataset.theme); updateButtons(); });
      });
      updateButtons();

      // Mobile menu
      const menuBtn = document.getElementById('mobile-menu-btn');
      const mobileMenu = document.getElementById('mobile-menu');
      const hamburgerIcon = menuBtn.querySelector('.hamburger-icon');
      const closeIcon = menuBtn.querySelector('.close-icon');

      const openMenu = () => {
        // Force scrolled (compact) state while menu is open for consistent UI
        header.dataset.scrolled = 'true';
        mobileMenu.classList.remove('hidden');
        mobileMenu.offsetHeight; // Force reflow
        mobileMenu.classList.add('drawer-open');
        mobileMenu.setAttribute('aria-hidden', 'false');
        menuBtn.setAttribute('aria-expanded', 'true');
        hamburgerIcon.classList.add('hidden');
        closeIcon.classList.remove('hidden');
        document.body.classList.add('mobile-menu-open');
      };

      const closeMenu = () => {
        mobileMenu.classList.remove('drawer-open');
        mobileMenu.setAttribute('aria-hidden', 'true');
        menuBtn.setAttribute('aria-expanded', 'false');
        hamburgerIcon.classList.remove('hidden');
        closeIcon.classList.add('hidden');
        document.body.classList.remove('mobile-menu-open');
        // Restore scroll-aware state
        updateHeader();
        setTimeout(() => {
          if (!mobileMenu.classList.contains('drawer-open')) mobileMenu.classList.add('hidden');
        }, 200);
      };

      menuBtn.addEventListener('click', () => {
        mobileMenu.classList.contains('drawer-open') ? closeMenu() : openMenu();
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && mobileMenu.classList.contains('drawer-open')) closeMenu();
      });

      mobileMenu.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', closeMenu);
      });

      window.matchMedia('(min-width: 768px)').addEventListener('change', (e) => {
        if (e.matches && mobileMenu.classList.contains('drawer-open')) closeMenu();
      });
    })();
  </script>
</header>
